using Backend.Data;
using Backend.DTO;
using Backend.Models;
using Microsoft.EntityFrameworkCore;

namespace Backend.Services
{
    public class FriendsService
    {
        private readonly ApplicationDbContext _context;

        public FriendsService(ApplicationDbContext context)
        {
            _context = context;
        }

        public async Task<List<FriendDTO>> GetFriends(int id) 
        {
            List<Friend> friends = await _context.Friends.Where(f => (f.SenderId == id || f.ReceiverId == id) && f.Confirmed).ToListAsync();

            List<FriendDTO> friendDTOs = new List<FriendDTO>();

            foreach (Friend f in friends)
            {
                int friendId = (id != f.ReceiverId) ? f.ReceiverId : f.SenderId;

                User friend = await _context.Users.FindAsync(friendId);

                FriendDTO friendDTO = new FriendDTO
                {
                    FirstName = friend.FirstName,
                    LastName = friend.LastName,
                    Email = friend.Email,
                    RequestTime = f.TimeSent,
                    ConfirmedTime = f.TimeConfirmed
                };
                friendDTOs.Add(friendDTO);
            }
            return friendDTOs;
        }

        public async Task<List<FriendDTO>> GetRequests(int id) 
        {
            var requests = await _context.Friends.Where(f => f.ReceiverId == id && !f.Confirmed).ToListAsync();
            List<FriendDTO> friendDTOs = new List<FriendDTO>();

            foreach (var f in requests) 
            {
                User sender = await _context.Users.FindAsync(f.SenderId);

                FriendDTO friendDTO = new FriendDTO
                {
                    FirstName = sender.FirstName,
                    LastName = sender.LastName,
                    Email = sender.Email,
                    RequestTime = f.TimeSent,
                    ConfirmedTime = f.TimeConfirmed
                };
                friendDTOs.Add(friendDTO);
            }
            return friendDTOs;
        }

        public async Task<bool> AddRequest(int senderId, int receiverId) 
        {
            if (await _context.Friends.FindAsync(receiverId, senderId) != null || await _context.Friends.FindAsync(senderId, receiverId) != null)
            { 
                return false;
            }
            _context.Friends.Add(new Friend
            {
                SenderId = senderId,
                ReceiverId = receiverId,
                Confirmed = false,
                TimeSent = DateTime.Now
            });
            await _context.SaveChangesAsync();
            return true;
        }

        public async Task<bool> AcceptRequest(int senderId, int receiverId)
        {
            Friend? friend = await _context.Friends.FirstOrDefaultAsync(f => f.SenderId == senderId && f.ReceiverId == receiverId);

            if (friend == null)
            {
                Console.WriteLine("grr");
                return false;
            }

            friend.Confirmed = true;
            friend.TimeConfirmed = DateTime.Now;
            
            _context.Friends.Update(friend);
            await _context.SaveChangesAsync();
            return true;
        }
    }
}
